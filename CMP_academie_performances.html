<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>CMP Académie Performances</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>.no-print{display:none!important}</style>
</head>
<body>
  <h2>Résultats</h2>
  <div class="card">
    <p>Exemple de résultats affichés ici...</p>
    <table id="scoreTable">
      <tr><td>Compétence A</td><td>75%</td></tr>
      <tr><td>Compétence B</td><td>60%</td></tr>
    </table>
  </div>
  <button id="exportPdf">Exporter PDF</button>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const btn = document.getElementById("exportPdf");
  if(!btn) return;
  btn.addEventListener("click", async function(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const margins = {l:10, r:10, t:10, b:10};

    function findResultsCard(){
      const hs = Array.from(document.querySelectorAll('h2'));
      let h = hs.find(x => (x.textContent||'').trim().toLowerCase() === 'résultats');
      if (h && h.closest('.card')) return h.closest('.card');
      const t = document.getElementById('scoreTable');
      if (t && t.closest('.card')) return t.closest('.card');
      return document.body;
    }
    const target = findResultsCard();

    async function getCenteredLogoInfo(){
      const logoEl = document.querySelector('img[src*="logo"], img[src*="bandeau"], img[src*="header"]');
      if (!logoEl) return null;
      try{
        const c = await html2canvas(logoEl, {scale:2, useCORS:true});
        const imgData = c.toDataURL('image/jpeg','1.0');
        const ratio = c.height / c.width;
        let wmm = Math.min(pageW - (margins.l + margins.r), 180);
        let hmm = wmm * ratio;
        if (hmm > 50){ hmm = 50; wmm = hmm / ratio; }
        const x = (pageW - wmm)/2;
        return {imgData, wmm, hmm, x};
      }catch(e){ return null; }
    }

    const resultsCanvas = await html2canvas(target, {scale:2, useCORS:true, ignoreElements: el => el.classList && el.classList.contains('no-print')});

    const header = await getCenteredLogoInfo();
    let yCursor = margins.t;
    if (header){
      doc.addImage(header.imgData, 'JPEG', header.x, yCursor, header.wmm, header.hmm);
      yCursor += header.hmm + 6;
    }

    const imgW = pageW - (margins.l + margins.r);
    const pxPerMm = resultsCanvas.width / imgW;
    const usableH = pageH - yCursor - margins.b;
    const sliceHpx = Math.ceil(usableH * pxPerMm);
    let y = 0, first = true;
    const slice = document.createElement('canvas');
    const ctx = slice.getContext('2d');
    slice.width = resultsCanvas.width;

    while (y < resultsCanvas.height){
      const h = Math.min(sliceHpx, resultsCanvas.height - y);
      slice.height = h;
      ctx.clearRect(0,0,slice.width,slice.height);
      ctx.drawImage(resultsCanvas, 0, y, resultsCanvas.width, h, 0, 0, slice.width, h);
      const part = slice.toDataURL('image/jpeg','1.0');
      if (!first) { doc.addPage(); yCursor = margins.t; }
      doc.addImage(part, 'JPEG', margins.l, yCursor, imgW, h/pxPerMm);
      first = false;
      y += h;
    }

    doc.save('CMP_resultats.pdf');
  });
});
</script>
</body>
</html>