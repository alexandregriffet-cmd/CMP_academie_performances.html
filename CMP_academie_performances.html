<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CMP – Compétences Mentales de Performances | Académie de Performances</title>
  <meta name="description" content="CMP – Questionnaire de compétences mentales (inspiré OMSAT-4), par Alexandre Griffet." />
  <style>
    :root{ --line:#e6e6e9; --muted:#596073; --ink:#0a0a0a; --bg:#ffffff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.5; color: var(--ink); background: var(--bg); }
    h1 { margin: 0 0 8px; }
    h2 { margin: 0 0 12px; }
    .muted { color: var(--muted); }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin: 16px 0; background:#fff; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .item { padding: 12px; border: 1px solid var(--line); border-radius: 10px; }
    .dim { font-weight: 600; margin-bottom: 4px; }
    .scale { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
    .btn { padding: 10px 14px; border: 1px solid #222; border-radius: 10px; background: #fff; cursor: pointer; }
    .btn.primary { background: #111; color: #fff; }
    .footer { margin-top: 24px; font-size: 13px; color: #666; }
    .flex { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    label.option { display: inline-flex; align-items: center; gap: 6px; }
    .scores { overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border: 1px solid var(--line); padding: 8px; text-align: center; }
    th { background: #fafafa; }
    .consent { background: #f8f9fb; border: 1px solid #e4e7ee; padding: 12px; border-radius: 10px; }
    .banner { width: 100%; border-radius: 12px; overflow: hidden; border: 1px solid var(--line); }
    .banner img { width: 100%; height: auto; display: block; }
    .section-title { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .mini-banner { width: 240px; max-width: 35%; }
    @media (max-width:700px){ .mini-banner{ width: 180px; } }
  </style>
</head>
<body>

  <div class="banner" style="margin-bottom:16px">
    <img src="assets/bandeau.jpg" alt="Académie de Performances – Alexandre Griffet" />
  </div>

  <h1>CMP – Compétences Mentales de Performances</h1>
  <div class="muted">Auto-évaluation des compétences mentales (inspiré OMSAT-4)</div>

  <div id="app" class="card">
    <div class="consent" id="consentBox"></div>
    <div class="flex" style="margin-top:8px">
      <div><label>Identifiant (optionnel) : <input id="pid" placeholder="Prénom ou code" /></label></div>
      <div><label>Contexte :
        <select id="context">
          <option>Entraînement</option>
          <option>Compétition</option>
          <option>Scolaire</option>
          <option>Autre</option>
        </select></label>
      </div>
      <div><label>Date : <input type="date" id="pdate"></label></div>
    </div>
    <div id="items" class="grid" style="margin-top:16px;"></div>
    <div class="actions">
      <button id="compute" class="btn primary">Calculer les scores</button>
      <button id="reset" class="btn">Réinitialiser</button>
      <button id="exportCsv" class="btn">Exporter CSV</button>
      <button id="exportJson" class="btn">Exporter JSON</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">
      <h2>Résultats</h2>
      <div class="mini-banner">
        <img src="assets/bandeau.jpg" alt="Académie de Performances – Résultats" />
      </div>
    </div>

    <div class="scores" style="margin-top:8px">
      <table id="scoreTable">
        <thead><tr id="scoreHead"></tr></thead>
        <tbody><tr id="scoreRow"></tr></tbody>
      </table>
    </div>

    <canvas id="radar" width="600" height="420" style="margin-top:16px;"></canvas>

    <div class="scores" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Détail par item (% après inversion si nécessaire)</h3>
      <table id="itemsTable">
        <thead><tr id="itemsHead"></tr></thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="footer">Échelle 1–7 ; inversion si <em>(inversé)</em> : <code>score' = 8 − score</code>. Les pourcentages sont normalisés sur 7 points (x/7×100).</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const state = { meta:null, items:[], chart:null };

    async function load() {
      const res = await fetch('questions.json', { cache: 'no-store' });
      const data = await res.json();
      state.meta = data;
      state.items = data.items;
      document.getElementById('consentBox').innerHTML =
        "<strong>"+data.consent.title+"</strong><br>"+data.consent.text;
      document.getElementById('pdate').valueAsDate = new Date();
      renderItems(data);
      buildScoreTable(data.dimensions);
      buildItemsTableHeader();
    }

    function renderItems(data) {
      const wrap = document.getElementById('items');
      wrap.innerHTML = '';
      const scaleMin = data.scale.min, scaleMax = data.scale.max;
      data.items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = \`
          <div class="dim">\${it.dimension}</div>
          <div><strong>\${it.id}</strong> — \${it.text} \${it.reverse ? '<span class="muted">(inversé)</span>' : ''}</div>
          <div class="scale" role="radiogroup" aria-label="\${it.id}">
            \${Array.from({length: scaleMax - scaleMin + 1}, (_,i)=>i+scaleMin).map(v => \`
              <label class="option">
                <input type="radio" name="\${it.id}" value="\${v}"> \${v}
              </label>
            \`).join('')}
            <span class="muted">(\${data.scale.anchors[0]} → \${data.scale.anchors[1]})</span>
          </div>\`;
        wrap.appendChild(div);
      });
    }

    function buildScoreTable(dimensions){
      const head = document.getElementById('scoreHead');
      const row  = document.getElementById('scoreRow');
      head.innerHTML = '<th>Participant</th>' + dimensions.map(d=>\`<th>\${d} (%)</th>\`).join('') + '<th>Moyenne (%)</th>';
      row.innerHTML  = '<td id="pidCell">—</td>' + dimensions.map((_,i)=>\`<td id="d\${i}">—</td>\`).join('') + '<td id="avg">—</td>';
    }

    function buildItemsTableHeader(){
      const head = document.getElementById('itemsHead');
      head.innerHTML = '<th>Item</th><th>Dimension</th><th>Réponse (1–7)</th><th>Score ajusté</th><th>%</th>';
    }

    function computeScores(){
      const dims = state.meta.dimensions;
      const perDim = Object.fromEntries(dims.map(d=>[d, []]));
      const itemRows = [];
      const min = state.meta.scale.min, max = state.meta.scale.max;

      const getVal = name => {
        const el = document.querySelector(\`input[name="\${name}"]:checked\`);
        return el ? Number(el.value) : null;
      };

      let missing = [];
      state.items.forEach(it=>{
        const v = getVal(it.id);
        if (v==null) { missing.push(it.id); return; }
        const adj = it.reverse ? ((max + 1) - v) : v; // 8 - v pour 1..7
        perDim[it.dimension].push(adj);
        const pct = Math.round((adj/7)*10000)/100; // %
        itemRows.push({ id: it.id, dim: it.dimension, raw: v, adj, pct });
      });

      if (missing.length){
        alert("Réponses manquantes : " + missing.join(", "));
        return null;
      }

      const meansPct = dims.map(d=>{
        const arr = perDim[d];
        const m = arr.reduce((a,b)=>a+b,0)/arr.length; // 1..7
        return Math.round((m/7)*10000)/100; // en %
      });
      const globalPct = Math.round((meansPct.reduce((a,b)=>a+b,0)/meansPct.length)*100)/100; // %
      return { meansPct, globalPct, itemRows };
    }

    function updateUI(res){
      if (!res) return;
      document.getElementById('pidCell').textContent = document.getElementById('pid').value || '—';
      res.meansPct.forEach((v,i)=> document.getElementById('d'+i).textContent = v.toFixed(2));
      document.getElementById('avg').textContent = res.globalPct.toFixed(2);
      drawStar(res.meansPct);
      renderItemsTable(res.itemRows);
    }

    function drawStar(valuesPct){
      const ctx = document.getElementById('radar');
      if (state.chart){ state.chart.destroy(); }
      state.chart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: state.meta.dimensions,
          datasets: [{ label: 'Profil (%)', data: valuesPct, fill: true }]
        },
        options: {
          responsive: true,
          scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function renderItemsTable(rows){
      const body = document.getElementById('itemsBody');
      body.innerHTML = rows.map(r=>\`
        <tr>
          <td>\${r.id}</td>
          <td>\${r.dim}</td>
          <td>\${r.raw}</td>
          <td>\${r.adj}</td>
          <td>\${r.pct.toFixed(2)}</td>
        </tr>
      \`).join('');
    }

    function resetForm(){
      document.querySelectorAll('input[type="radio"]').forEach(el=> el.checked = false);
      buildScoreTable(state.meta.dimensions);
      buildItemsTableHeader();
      document.getElementById('itemsBody').innerHTML = '';
      if (state.chart){ state.chart.destroy(); state.chart = null; }
    }

    function exportCSV(){
      const pid = document.getElementById('pid').value || '';
      const date = document.getElementById('pdate').value || '';
      const ctx  = document.getElementById('context').value || '';
      const res = computeScores(); if (!res) return;
      const headers = ['participant','date','contexte', ...state.meta.dimensions.map(d=>d+' (%)'),'moyenne (%)'];
      const values  = [pid, date, ctx, ...res.meansPct.map(v=>v.toFixed(2)), res.globalPct.toFixed(2)];
      let csv = headers.join(',') + '\n' + values.join(',') + '\n\nItem,Dimension,Reponse,Score ajusté,Pourcentage\n';
      res.itemRows.forEach(r=>{ csv += [r.id, r.dim, r.raw, r.adj, r.pct.toFixed(2)].join(',') + '\n'; });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = \`cmp_scores_\${pid || 'anonyme'}_\${date || 'date'}.csv\`;
      a.click();
    }

    function exportJSON(){
      const pid = document.getElementById('pid').value || '';
      const date = document.getElementById('pdate').value || '';
      const ctx  = document.getElementById('context').value || '';
      const res = computeScores(); if (!res) return;
      const out = {
        instrument: state.meta.instrument,
        version: state.meta.version,
        participant: pid,
        date, contexte: ctx,
        scores_pct: Object.fromEntries(state.meta.dimensions.map((d,i)=>[d,res.meansPct[i]])),
        moyenne_pct: res.globalPct,
        items: res.itemRows
      };
      const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = \`cmp_scores_\${pid || 'anonyme'}_\${date || 'date'}.json\`;
      a.click();
    }

    document.addEventListener('click', e=>{
      if (e.target.id==='compute'){ const r = computeScores(); updateUI(r); }
      if (e.target.id==='reset'){ resetForm(); }
      if (e.target.id==='exportCsv'){ exportCSV(); }
      if (e.target.id==='exportJson'){ exportJSON(); }
    });

    load();
  </script>
</body>
</html>
